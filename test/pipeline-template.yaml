apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: pipeline
spec:
  params:
  - name: repo-url
    description: git仓库URL
  - name: repo-full-name
    description: git仓库名称, 用于执行gitea请求 (创建工单,评论)
  - name: repo-branch
    description: git仓库分支
  - name: repo-ref
    description: git仓库SHA
  - name: src-root
    description: 代码根目录
    default: 
  - name: version
    description: 当前项目版本

  tasks:
  - name: params
    taskSpec:
      steps:
      - image: 10.1.40.43:5000/busybox:1.31
        script: |
          echo -n $(params.job-id) > $(results.job-id.path)
      params:
      - name: job-id
        description: |
          pipelines内唯一子目录,作为project根目录(伪pvc),为后续步骤的数据来源/结果数据
      results:
      - name: job-id
    params:
    - name: job-id
      value: $(context.pipelineRun.name)-$(params.repo-ref)

  - name: ci
    taskRef:
      name: pipelinerun-apply
    params:
    - name: name
      value: $(context.pipelineRun.name)-pipeline-wrapper-ci
    - name: spec
      value: |
        pipelineRef:
          name: pipeline-wrapper
        serviceAccountName: pipeline-git-ssh
        workspaces:
        - name: pipelines
          persistentVolumeClaim:
            claimName: pipeline-all-workspaces-pvc
        - name: gitea-user-token
          secret:
            SecretName: gitea-user-token
        params:
        - name: job-id 
          value: $(tasks.params.results.job-id)
        - name: repo-url
          value: $(params.repo-url)
        - name: repo-full-name
          value: $(params.repo-full-name)
        - name: repo-ref
          value: $(params.repo-ref) 
        - name: notify
          value: ddddddddddddddddddddddddddd "dddd" dddd
        - name: version
          value: $(params.version)
        - name: before-env
          value: auto-test
        - name: env
          value: auto-test
        - name: pipeline-name
          value: pipeline-ci
        - name: pipeline-workspaces
          value: |
            - name: mvn-settings
              configmap:
                name: mvn-settings
            - name: mvn-local-repo
              persistentVolumeClaim:
                claimName: pipeline-mvn-repo-pvc
        - name: pipeline-params
          value: |
            - name: work-id
              value: "1111"
            - name: src-root
              value: api-gateway
---

apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: tt
spec:
  pipelineRef:
    name: pipeline
  serviceAccountName: pipeline-git-ssh
  params:
  - name: repo-url
    value: ssh://git@10.1.40.43:30220/root/test-project.git
  - name: repo-full-name
    value: root/test
  - name: repo-branch
    value: master
  - name: repo-ref
    value: 37f0e40c7d15a380011616c8e08ab959c753d6a6 
  - name: version
    value: "1.0.0"
  - name: src-root
    value: api-gateway
