apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: gitea
spec:
  params:
    - name: gitea
      default: gitea-gitea-http
    - name: port
      default: "3000"
    - name: token
    - name: cmd
    - name: args
  steps:
    - name: await
      image: 10.1.40.43:5000/curlimages/curl
      securityContext:
        runAsUser: 0

      script: |
        function url() {
          method=$1
          path=$2
          host=$(params.gitea)
          port=$(params.port)
          token=$(params.token)
          data=$3
        
          echo "curl -X $method http://$host:$port/api/v1$path?access_token=$token" \
                -H \"accept: application/json\" -H \"Content-Type: application/json\" \
                -d \'$data\' \
                -f
        }
        
        function createIssue() {
          owner=$1
          repo=$2
          title=$3
          body=$4
          assignees=$5  #(echo $3|sed 's|"|\\"|g')
          url=$(url POST /repos/$owner/$repo/issues "{
                  \"title\": \"$title\",
                  \"body\": \"$body\", 
                  \"assignees\": [ $assignees ] }")
          sh -c "$url"
        }
        
        function createComment() {
          owner=$1                                                                     
          repo=$2                                                                     
          issue=$3
          body=$4
          url=$(url POST /repos/$owner/$repo/issues/$issue/comments "{ \"body\": \"$body\" }")
          sh -c "$url"                                
        }

        $(params.cmd) $(params.args)
